<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resizable Rectangle Example</title>
    <!-- Google Material Icons CSS -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Google Material Design Lite CSS -->
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
    <!-- Google Material Design Lite JS -->
    <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../Tabels/tabels.css">
    <script src="path/to/includeHTML.js"></script>
</head>
<body>
    <div class="main-con">
        <div class="top-header">
            <!-- Content for top header -->
            <a class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect back-button" href="../../Index.html" style="color: aliceblue;">
                <span class="material-icons">arrow_back</span> Back
            </a>
        </div>
        <div class="bottom-con">
            <div class="left-content" id="leftContentContainer">
                <!-- Iframe will be dynamically added here -->
            </div>
            <div class="right-content">
                <div class="right-info" id="selectedTableInfo">
                    <!-- Selected table info will be displayed here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="customerModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <label for="customerName">Enter customer name:</label>
            <input type="text" id="customerName" inputmode="text" autocomplete="off">
            <label id="errorMessage" style="color: red;"></label>
            <div class="button-container">
                <button class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect btn btn-lg mb-1 modbtn" onclick="submitCustomerName()">Submit</button>
                <button class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect btn btn-lg mb-1 modbtn" onclick="closeModal()">Cancel</button>
            </div>

            <!-- Your existing modal code here -->
            <div id="keyboardContainer">
            <!-- Add an iframe to include the virtual keyboard -->
                 <iframe src="keyboard.html" height="260px"></iframe>
             </div>
            <div class="tab-order-list">
                <div class="tab-existing-order-list">
                    
                </div>
            </div>



            <!-- Your existing modal script and other content here -->
        </div>
    </div>

    <!-- Google Material Design Lite JS -->
    <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
    <!-- Bootstrap JS (optional) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Variable to store the customer name temporarily
        var currentCustomerName = '';
        var selectedTable;

        function openModal(callback) {
            var modal = document.getElementById('customerModal');
            modal.style.display = 'block';

            // Set the callback function for submitting customer name
            submitCustomerName.callback = callback;
            fetchOrders();

            // Show the on-screen keyboard
             var keyboardContainer = document.getElementById('keyboardContainer');
            fetch('keyboard.html')
                .then(response => response.text())
                .then(data => {
                    keyboardContainer.innerHTML = data;
                })
                .catch(error => {
                    console.error('Error loading keyboard:', error);
                });
        }

        function closeModal() {
            var modal = document.getElementById('customerModal');
            modal.style.display = 'none';
        }

        function submitCustomerName() {
            var customerNameInput = document.getElementById('customerName');
            currentCustomerName = customerNameInput.value;
            var errorMessageLabel = document.getElementById('errorMessage');

            if (currentCustomerName !== null && currentCustomerName !== "") {
                closeModal();

                // Call the callback function with the entered customer name
                if (typeof submitCustomerName.callback === 'function') {
                    submitCustomerName.callback(currentCustomerName);
                }
            } else {
                // Show error message and make the label red
                errorMessageLabel.textContent = 'Please provide customer name.';
                errorMessageLabel.style.color = 'red';
            }
        }

        function openKeyboard() {
            var keyboard = document.getElementById('virtualKeyboard');
            keyboard.style.display = 'block';
        }

        function appendToInput(value) {
            var customerNameInput = document.getElementById('customerName');
            customerNameInput.value += value;
        }

        function addNewOrder() {
            // Pass the reserveTable function as the callback
            submitCustomerName.callback = reserveTable;

            // Open the modal and enable the input field when the "Add New Order" button is clicked
            openModal(submitCustomerName.callback);

            openKeyboard();
        }
        function openExistingOrder(){
            
        }


        function create_order(){
            const data = {
                CustomerName: currentCustomerName,
                OrderType: 'Online',
                TableNumber: selectedTable,
                Price: 0,
                employeename: 'Employee1',
                status: 'Open'
            };
            fetch('http://127.0.0.1:5000/create_order', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.text();
                })
                .then(data => {
                    console.log('Success:', data);
                })
                .catch(error => {
                    console.error('Error:', error);
                });

        }


        function reserveTable(tableNumber) {
            selectedTable = tableNumber;
            openModal(function (customerName) {
                // Validate and assign the table based on the entered customer name
                if (customerName === currentCustomerName) {
                    // Table allocation logic...
                    var selectedTableInfo = document.getElementById("selectedTableInfo");
                    selectedTableInfo.innerHTML = '<h1 class="order-text"><b>Table : ' + selectedTable + '</b></h1>' +
                        '<h1 class="order-text">Customer Name: ' + currentCustomerName + '</h1>'; // Use customerName
                    create_order();

                    // Change the color of the selected table button to red
                    var selectedButton = document.getElementById("button" + tableNumber);
                    if (selectedButton) {
                        selectedButton.style.backgroundColor = 'red';
                    }


                    // Create an iframe element
                    var iframe = document.createElement("iframe");
                    iframe.src = '../products/category/category.html';
                    iframe.style.width = '100%';
                    iframe.style.height = '100%';
                    iframe.style.border = 'none';

                    // Replace the left-content with the iframe
                    var leftContentContainer = document.getElementById("leftContentContainer");
                    leftContentContainer.innerHTML = ''; // Clear previous content
                    leftContentContainer.appendChild(iframe);
                } else {
                    alert('Invalid customer name for table reservation.');
                }
            });
        }


        // Create buttons using the DOM API
        var tableButtonsContainer = document.getElementById("leftContentContainer");


        function arrange_table(limit){
            for (let i = 1; i <= limit; i++) {
                var button = document.createElement("button");
                button.id = "button" + i;  // Set a unique ID for each button
                button.className = "custom-button";
                button.style.width = "15.375rem";
                button.style.height = "9.375rem";
                button.textContent = "Table " + i;
                button.onclick = function () {
                    reserveTable(i);
                };

                tableButtonsContainer.appendChild(button);
            }

        }


        function fetchData() {
            fetch('http://localhost:5000/get_Table_limit')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    arrange_table(data.data);
                })
                .catch(error => {
                    console.error('There was a problem with the fetch operation:', error);
                });
        }
        document.addEventListener('DOMContentLoaded', fetchData);


        async function fetchOrders() {
            try {
                const response = await fetch('http://127.0.0.1:5000/get_orders_for_day'); // Replace with your API URL
                const orders = await response.json();
                populateOrderList(orders);
            } catch (error) {
                console.error('Error fetching orders:', error);
            }
        }

        function createOrderButton(order) {
            var button = document.createElement("button");
            button.className = " tab-existing-order-list-btn";
            button.onclick = function () {
                openExistingOrder(order.CustomerName, order.TableNumber, order.Price);
            };

            var h1Name = document.createElement("h1");
            h1Name.textContent = order.CustomerName;

            var h3Table = document.createElement("h3");
            h3Table.textContent = "Table " + order.TableNumber;

            var h2Price = document.createElement("h2");
            h2Price.textContent = "£" + order.Price.toFixed(2);

            button.appendChild(h1Name);
            button.appendChild(h3Table);
            button.appendChild(h2Price);

            return button;
        }


        function populateOrderList(currentordersintable) {
            var tabOrderListContainer = document.querySelector(".tab-order-list");

            // Clear existing content
            tabOrderListContainer.innerHTML = "";

            for (var i = 0; i < currentordersintable.length; i++) {
                var order = currentordersintable[i];

                // Create button
                var button = createOrderButton(order);

                // Append button directly to the main container
                tabOrderListContainer.appendChild(button);
            }

            console.log("Number of buttons appended:", currentordersintable.length);
        }


    </script>
</body>
</html>